import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { useLeaderboard } from '../hooks/useLeaderboard';
import { ScoreRow } from '../components/leaderboard/ScoreRow';
import type { GameMode, Difficulty } from '../types';

type Period = 'daily' | 'weekly';

const DIFFICULTY_TABS: { id: Difficulty; label: string; color: string; active: string }[] = [
  { id: 'easy',   label: 'ğŸŸ¢ EASY',   color: 'border-green-300 text-green-200',  active: 'bg-green-400 text-white border-green-400' },
  { id: 'medium', label: 'ğŸŸ¡ MEDIUM', color: 'border-yellow-300 text-yellow-200', active: 'bg-yellow-400 text-white border-yellow-400' },
  { id: 'hard',   label: 'ğŸ”´ HARD',   color: 'border-red-300 text-red-200',       active: 'bg-red-400 text-white border-red-400' },
];

export function Leaderboard() {
  const navigate = useNavigate();
  const [period, setPeriod] = useState<Period>('daily');
  const [mode, setMode] = useState<GameMode>('basic');
  const [difficulty, setDifficulty] = useState<Difficulty>('medium');
  const { entries, isLoading, error, myRank, myScore, totalCount } = useLeaderboard({ period, mode, difficulty });

  const topPercent = myRank && totalCount > 0
    ? Math.ceil((myRank / totalCount) * 100)
    : null;

  return (
    <div className="min-h-screen flex flex-col">
      <header className="p-4 flex items-center gap-4">
        <button
          onClick={() => navigate('/')}
          className="text-white/80 hover:text-white"
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </button>
        <h1 className="text-xl font-bold text-white">ë¦¬ë”ë³´ë“œ</h1>
      </header>

      {/* ê¸°ê°„ íƒ­ */}
      <div className="px-4 pt-2">
        <div className="flex bg-white/20 rounded-full p-1 w-fit mx-auto">
          {(['daily', 'weekly'] as const).map((p) => (
            <button
              key={p}
              onClick={() => setPeriod(p)}
              className={`relative px-6 py-2 rounded-full text-sm font-medium transition-colors ${
                period === p ? 'text-purple-700' : 'text-white/80 hover:text-white'
              }`}
            >
              {period === p && (
                <motion.div
                  layoutId="periodTab"
                  className="absolute inset-0 bg-white rounded-full"
                  transition={{ type: 'spring', bounce: 0.2, duration: 0.4 }}
                />
              )}
              <span className="relative z-10">{p === 'daily' ? 'ì˜¤ëŠ˜' : 'ì´ë²ˆ ì£¼'}</span>
            </button>
          ))}
        </div>
      </div>

      {/* ëª¨ë“œ íƒ­ */}
      <div className="px-4 pt-3">
        <div className="flex gap-2 justify-center">
          {([
            { id: 'basic' as GameMode, label: 'ê¸°ë³¸' },
            { id: 'reverse' as GameMode, label: 'ë¦¬ë²„ìŠ¤' },
          ]).map(({ id, label }) => (
            <button
              key={id}
              onClick={() => setMode(id)}
              className={`px-5 py-1.5 rounded-full text-sm font-semibold border-2 transition-all ${
                mode === id
                  ? 'bg-white text-purple-700 border-white shadow'
                  : 'bg-transparent text-white/70 border-white/30 hover:border-white/60 hover:text-white'
              }`}
            >
              {label}
            </button>
          ))}
        </div>
      </div>

      {/* ë‚œì´ë„ íƒ­ */}
      <div className="px-4 pt-2 pb-1">
        <div className="flex gap-2 justify-center">
          {DIFFICULTY_TABS.map(({ id, label, color, active }) => (
            <button
              key={id}
              onClick={() => setDifficulty(id)}
              className={`px-4 py-1 rounded-full text-xs font-bold border-2 transition-all ${
                difficulty === id ? active : `bg-transparent ${color} hover:opacity-100 opacity-70`
              }`}
            >
              {label}
            </button>
          ))}
        </div>
      </div>

      <main className="flex-1 p-4 pb-48 overflow-y-auto">
        {isLoading && (
          <div className="flex justify-center py-12">
            <motion.div
              className="w-8 h-8 border-4 border-white/30 border-t-white rounded-full"
              animate={{ rotate: 360 }}
              transition={{ duration: 1, repeat: Infinity, ease: 'linear' }}
            />
          </div>
        )}

        {error && (
          <div className="text-center py-12">
            <p className="text-white/80">{error}</p>
            <p className="text-white/60 text-sm mt-2">Supabase ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”</p>
          </div>
        )}

        {!isLoading && !error && entries.length === 0 && (
          <div className="text-center py-12">
            <p className="text-white/80 text-lg mb-2">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”</p>
            <p className="text-white/60 text-sm">ì²« ë²ˆì§¸ ë„ì „ìê°€ ë˜ì–´ë³´ì„¸ìš”!</p>
            <motion.button
              onClick={() => navigate('/')}
              className="mt-6 px-6 py-3 bg-white text-purple-600 font-semibold rounded-full"
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
            >
              ê²Œì„ ì‹œì‘í•˜ê¸°
            </motion.button>
          </div>
        )}

        {!isLoading && !error && entries.length > 0 && (
          <div className="space-y-3">
            {entries.map((entry, index) => (
              <ScoreRow
                key={`${entry.nickname}-${index}`}
                entry={entry}
                isCurrentUser={entry.isMe}
                index={index}
              />
            ))}
          </div>
        )}
      </main>

      {/* í•˜ë‹¨ ê³ ì • ì˜ì—­ */}
      <div className="fixed bottom-0 left-0 right-0 max-w-lg mx-auto">
        {myRank && (
          <motion.div
            initial={{ opacity: 0, y: 16 }}
            animate={{ opacity: 1, y: 0 }}
            className="mx-4 mb-3 rounded-2xl overflow-hidden shadow-2xl"
          >
            <div className="bg-white/95 backdrop-blur-sm border border-purple-100 px-5 py-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-400 mb-0.5">ë‚˜ì˜ ìˆœìœ„</p>
                  <p className="text-2xl font-extrabold text-purple-700">{myRank}ìœ„</p>
                </div>
                {topPercent !== null && (
                  <div className="text-center">
                    <p className="text-xs text-gray-400 mb-0.5">ìƒìœ„</p>
                    <p className="text-2xl font-extrabold text-pink-500">{topPercent}%</p>
                  </div>
                )}
                {myScore !== null && (
                  <div className="text-right">
                    <p className="text-xs text-gray-400 mb-0.5">ìµœê³  ì ìˆ˜</p>
                    <p className="text-2xl font-extrabold text-gray-800">{myScore.toLocaleString()}ì </p>
                  </div>
                )}
              </div>
            </div>
          </motion.div>
        )}

        <div className="pb-6" />
      </div>
    </div>
  );
}
